# ppt文案

[TOC]

## 时钟树

1. 时钟源,产生时钟
2. 数选器,配置寄存器选择需要的时钟源
3. 锁相环,倍频已有时钟
4. CSS时钟安全系统,对外部高速时钟进行监测,外部高速时钟
出现故障会直接切换回内部高速时钟,并触发中断
5. 分频器,也是寄存器可配置对已有时钟进行分频获取需要的时钟
6. 门控时钟,在不同电源模式下可关断时钟,减低功耗
7. MCO内部时钟输出,引出可检测时钟信号

## 电源

==datasheet的电源方案有断路==
注意:模拟域的参考电压小于电源电压,且参考电压代表的是ADC的满量程,且需要稳定

## 系统框图

没啥好说的,==唯一不确定的点是AHB_lite是AHB2AHB还是AHB的一个mux==

## cortex-M3

>Icode和Dcode和System这样设计的目的是什么?

1. I和D与S访问地址不同,可以同时传输,可以做到哈佛结构的优势;==但如果I和S同时取指令或者取向量时会怎么样?大概可能是会在AHB中插入等待==
2. I和D访问地址相同,不可同时传输,目的我觉得可能是考虑到了AHB的流水线结构;指令和文字池常量的地址可能比较比较大,如果在一个总线上的话,AHB主机就需要反复装填地址,会很麻烦;同时ARM建议Dcoed的优先级要高于指令,可能是为了防止数据相关性问题

>三种总线接口访问的场景都是什么

1. Icode:
   1. 指令寄存器取指令(注意只能读)
   2. PC寄存器取地址(注意只能读)
2. Dcode:
   1. 访存指令
   2. 调试命令
3. System:
   1. 访存指令
   2. 指令寄存器取指令
   3. PC寄存器取地址
   4. 调试命令

## DMA

1. IO数据传输方式 [了解更多点这里](https://www.jianshu.com/p/d1542085afde)
   1. 循环IO测试(CPU完全介入,无需额外硬件)
   CPU通过轮询检测IO的空/闲标志,去缓慢驱动外设
   2. 程序中断IO方式(CPU部分介入,增加中断控制)
   CPU写入/读取外设控制缓冲区,缓冲区空/满触发中断让CPU响应;
   缓冲区基本上不会太大,可能是给几级FIFO;
   反复中断对于处理器的代价也不小(拉满12个周期);
   当IO设备很多时,CPU可能只能处理中断
   3. DMA方式(CPU部分介入,增加中断控制,增加DMA)
    在内存和IO设备之间直接进行数据交换，不需要CPU的干预。当需要IO数据传输时，CPU将DMA初始化，之后DMA接管总线的使用权，将所需要的数据全部读入内存后，IO设备的控制器才会发出中断;
    这样可以有效降低中断次数,输出很多字符时有可观的性能;
    但值得注意DMA往往比CPU慢的多,如果DMA工作时CPU没啥事情做,那么说不定上两种方式会更好;
   4. 通道方式
   针对IO设备众多,输入输出频繁的,以上三种方式还是太慢其本质是针对不同外设类型的协处理器,dma只能配置参数
    ,而通道可以根据CPU的指令去初始化设备,搬运数据,收尾设备.
2. DMA原理
   1. 外设产生一个相关事件后，会将 DMA 请求信号发送到 DMA 控制器对应通道
   2. 按照软件(DMA_CCRx)配置的DMA 通道优先级，或者硬件默认规则，DMA 控制器依次处理这些请求,(加载源地址数据，地址由软件配置)(存储数据到目的地址，地址由软件配置)
   3. DMA 响应外设请求，通过总线访问外设的同时(执行一次 DMA 传输，计数器 DMA_CNDTRx 从配置的传输数量开始递减，表示剩余还有多少次 DMA 传输)，DMA 控制器会发送给外设一个应答信号，告知外设本次请求已响应
   4. 外设得到 DMA 的应答信号后，会立即释放掉本次请求
   5. DMA 侦测到外设请求消失后，对应的应答信号也会随之释放掉，本次 DMA 传输完成
   6. 注意DMA会占据系统总线,为了总体性能,总线仲裁器会进行调度,可能是round-robin型的冲裁方式
   7. 注意在一个通道,只能一个时间有一个使能(来源网上),优先级是给不同的通道使用的
3. ==DMA寄存器控制,也是有slave接口的但我看框图上没画,不知道是直接接在矩阵上还是?==

## USB OTG

1. 接口补充:
   1. USBDP:差分数据D+
   2. USBDM:差分数据D-
   3. USB-ID:USB器件识别
   4. USB_VBUS:主机电源,如果是主机供给电源
   5. USB_VBUS_ON:外部电源芯片使能信号
2. 结构包含:
   1. 外部FS PHY
   2. 内部OTG FS
   3. 内置DMA或FIFO
3. 机制稍显复杂,先跳过,以后再来学习

## Bus Matrix

1. 结构划分
   1. input stage
      组合送出数据或暂存数据
   2. decoder(+MUX)
      1. 与AHB_lite的decoder一样用于由地址选出正确的从机(给予HSEL信号)
      2. 同时也处理多重从机的响应信号和读取数据
   3. output stage
      1. 从输入级选择地址和控制信号和数据(仲裁)
      2. 确定何时在输入阶段的输入端口之间切换
      3. output只选择在寄存状态下的输入传输(一次传输中第一次会打一拍后面就不会了)
      4. 会生成响应的活动信号给input(表示我从机在忙)
2. 设计目的
   用于多层互联AHB,目的是改变移植性不强的multi连接的一组总线,取而代之的是多组lite总线(本质是给每个主机都配了一个decoder,给每个从机都加了仲裁).首先避免了一个多层互联总线的难更改性方便了脚本化(MUX很难改的),其次这使得不同主机可以映射出不同的从机地址,或者可以针对单个主机设计不同的remap方案
3. 问题:
   1. input stage明确了不连续的地址也需要有从机响应,但xml设置中可以使用非连续的映射地址,是否使用xml时,脚本会自动用slave_default去补齐不连续地址
   2. local slave和shared slave的区别
   local slave 指的是单独给某个master配置的从机
   shared slave 指的是给互联矩阵上接的从机

## Flash & Cache

1. 闪存物理构成
   1. package
   2. target(dies)
      独立的片选和接口,意味着不同target可以并行
   3. LUN
      由block组成
   4. block
      由page组成,可擦除最小单位
   5. page
      可编程最小单位(Flash可不能支持单纯的写覆盖,必须擦完再写)
   6. 闪存访问有个逻辑地址到物理页表的转换
2. 闪存逻辑构成
   1. 主存储块(按页擦除,按块写保护)
      1. 用户代码
      2. 数据
   2. 信息存储块
      1. 保密空间
      需要密钥配对
      1. 系统存储器
      出场的ISP bootloader
      1. 选项字节
      读写保护控制(反码验证),==已经有专门的flash空间了,为啥还要单独补对应的寄存器呢==
3. 闪存配置
   1. 需要根据时钟去设定预取延迟
   2. ==但报告里没说关闭cache后的延迟怎么设定==
4. 编程方式
   1. 在电编程-SWD烧录
   2. 在系统编程-UART串口
   3. 在应用编程-任何通讯方式,在程序中更新固件

## FSMC

内核对外部存储器的访问信号发送到AHB总线后，经过FSMC转换为符合外部存储器通信规约的信号，送到外部存储器的相应引脚，实现内核与外部存储器之间的数据交互。FSMC起到桥梁作用，既能够进行信号类型的转换，又能够进行信号宽度和时序的调整，屏蔽掉不同存储类型的差异
支持 NOR FLASH 6800 8080 SRAM拓展存储

## AHB to AHB

补充:当然降低面积也可以用MUX去把多个Slave合起来

## SDIO

## GPIO

1. GPIO功能
   1. 模拟输入
      * 直接将外部信号送入AD模块
   2. 浮空输入
      * 外部信号从管脚输入后经过TTL触发器输入到输入数据寄存器
   3. 上拉输入,下拉输入
      * 相比浮空输入,信号再进入触发器前接入了一个上拉/下拉电阻;
      * 浮空输入的电平在悬空状态下电平是不确定的,所以类似按键这种有一种情况是浮空态时,用上拉下拉可以将浮空态拉成电源或地
      * 提高抗干扰能力
      * 上拉电阻可以使得IO口输出有驱动能力的高电平
   4. 推挽输出
   5. 开漏输出
      * 只有N-MOS工作,因为P-MOS管关断,N-MOS管的漏端相当于是开路,所以叫开漏输出
      * 输出为0时,输出控制使得N-MOS导通,输出低电平
      * 输出为1时,输出控制使得N-MOS关断,输出纯粹由上下拉方式去决定
      * 开漏输出时,TTL触发器还在同时读取该输出端口的电平
   6. 复用推挽输出
   7. 复用开漏输出
2. 怎么控制
   1. 

## RCC配置寄存器

## CRC

## AHB to APB

## UART

## I2C

## SPI

## CAN

## timer

## ADC&Sensor

## DAC

## 比较器

## EXIT中断事件控制器

## DBG调试控制器

## CRS时钟回馈系统

## SYSCFG配置寄存器

## BKP备份寄存器